<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧食譜助手</title>
    <style>
        /* CSS 樣式保持不變，與之前提供的一致 */
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0; /* 淺灰色背景 */
            color: #333; /* 深灰色文字 */
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #0056b3; /* 標題藍色 */
            text-align: center;
            font-size: 2.5em; /* 大字體 */
            margin-bottom: 20px;
        }
        button {
            display: block;
            width: 80%;
            max-width: 400px;
            margin: 20px auto;
            padding: 20px 30px;
            font-size: 1.8em; /* 大按鈕文字 */
            background-color: #28a745; /* 綠色按鈕 */
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #218838;
        }
        .container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .section {
            display: none; /* 預設隱藏，透過 JS 顯示 */
            padding: 20px 0;
        }
        .section.active {
            display: block; /* 顯示當前活躍的區塊 */
        }

        /* 掃描介面樣式 */
        #scan-area {
            min-height: 250px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 1.5em;
            color: #666;
            position: relative; /* 用於定位攝像頭影像 */
            overflow: hidden; /* 防止攝像頭影像溢出 */
            background-color: #e9ecef; /* 掃描區域背景 */
            border-radius: 10px;
        }
        #scan-area video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 填充整個區域，可能裁剪 */
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1; /* 確保在引導文字下方 */
            border-radius: 10px;
        }
        #scan-area .overlay-text {
            position: relative; /* 確保文字在攝像頭上方 */
            z-index: 2;
            background-color: rgba(255, 255, 255, 0.7); /* 半透明背景，讓文字更清晰 */
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            color: #333;
        }

        #scan-area .icon {
            font-size: 4em; /* 大圖示 */
            margin-bottom: 10px;
        }
        #identified-ingredients {
            margin-top: 20px;
            font-size: 1.4em;
            text-align: center;
            color: #0056b3;
            font-weight: bold;
        }
        .ingredient-input-group {
            margin-top: 30px;
            text-align: center;
        }
        .ingredient-input-group label {
            font-size: 1.5em;
            margin-bottom: 10px;
            display: block;
        }
        .ingredient-input-group input[type="text"] {
            width: 70%;
            padding: 15px;
            font-size: 1.3em;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .ingredient-tags {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .ingredient-tag {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 20px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .ingredient-tag:hover {
            background-color: #d1d8df;
        }


        /* 食譜列表樣式 */
        .recipe-list {
            display: grid;
            gap: 25px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        .recipe-card {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .recipe-card:hover {
            transform: translateY(-5px);
        }
        .recipe-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid #ddd;
        }
        .recipe-card-content {
            padding: 15px;
        }
        .recipe-card h3 {
            font-size: 1.6em;
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            text-align: left;
        }
        .recipe-card p {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 5px;
        }
        .recipe-card .tags span {
            display: inline-block;
            background-color: #e0f7fa;
            color: #00796b;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        /* 食譜步驟樣式 */
        #recipe-title-display {
            font-size: 2.2em;
            text-align: center;
            color: #0056b3;
            margin-bottom: 30px;
        }
        .recipe-info {
            font-size: 1.3em;
            line-height: 1.8;
            margin-bottom: 20px;
        }
        .recipe-info p strong {
            color: #666;
        }

        .recipe-step {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 25px;
            margin-bottom: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .step-number {
            font-size: 2em;
            font-weight: bold;
            color: #e67e22; /* 橙色數字 */
            margin-bottom: 15px;
            text-align: center;
        }
        .step-image img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain; /* 圖片完整顯示 */
            display: block;
            margin: 0 auto 20px auto;
            border-radius: 8px;
        }
        .step-text {
            font-size: 1.8em; /* 烹飪步驟大字體 */
            color: #333;
            text-align: center;
        }
        .step-timer {
            font-size: 1.5em;
            color: #c0392b; /* 紅色計時器 */
            font-weight: bold;
            text-align: center;
            margin-top: 15px;
        }
        .navigation-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
        }
        .navigation-buttons button {
            width: 45%;
            margin: 0;
        }
        .nav-back { background-color: #6c757d; }
        .nav-back:hover { background-color: #5a6268; }
        .nav-next { background-color: #007bff; }
        .nav-next:hover { background-color: #0056b3; }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #007bff;
            color: white;
            font-size: 1.5em;
        }
        .top-nav button {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            margin: 0;
            padding: 0 10px;
            width: auto;
            max-width: none;
            box-shadow: none;
        }
        .top-nav button:hover {
            opacity: 0.8;
        }
        .top-nav .title {
            flex-grow: 1;
            text-align: center;
        }

        /* 收藏和購物清單按鈕 */
        .bottom-actions {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }
        .bottom-actions button {
            width: 48%;
            margin: 0;
            padding: 15px;
            font-size: 1.5em;
        }
        .favorite-btn { background-color: #ffc107; color: #333;}
        .favorite-btn:hover { background-color: #e0a800;}
        .shopping-btn { background-color: #17a2b8; }
        .shopping-btn:hover { background-color: #138496; }

        /* 確認識別結果彈窗 */
        #recognition-modal {
            display: none; /* 預設隱藏 */
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); /* 半透明黑色背景 */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        .modal-content h3 {
            font-size: 1.8em;
            color: #0056b3;
            margin-bottom: 20px;
        }
        .modal-content .recognized-items {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 25px;
            font-weight: bold;
        }
        .modal-content .modal-buttons button {
            display: inline-block;
            width: 45%;
            margin: 0 5px;
            padding: 15px 25px;
            font-size: 1.5em;
        }
        .modal-confirm-btn { background-color: #28a745; }
        .modal-confirm-btn:hover { background-color: #218838; }
        .modal-re-scan-btn { background-color: #ffc107; color: #333;}
        .modal-re-scan-btn:hover { background-color: #e0a800;}

        /* 加載指示器 */
        #loading-indicator {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 2em;
        }
        .spinner {
            border: 8px solid rgba(255,255,255,0.3);
            border-top: 8px solid #fff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <header class="top-nav" id="top-navbar" style="display: none;">
        <button onclick="goBack()">&lt;</button>
        <div class="title" id="nav-title">食譜名稱</div>
        <button onclick="toggleVoiceGuide()">🔊</button>
    </header>

    <main class="container">
        <section id="scan-page" class="section active">
            <h1>智慧食譜助手</h1>
            <button id="start-camera-btn">
                開啟攝像頭掃描
                <div class="icon">📸</div>
            </button>

            <div id="scan-area">
                <video id="camera-stream" autoplay playsinline style="display: none;"></video>
                <div class="overlay-text" id="scan-overlay-text">
                    <span class="icon">💡</span>
                    <p>請將食材對準鏡頭，然後點擊拍照</p>
                    <p>保持光線充足與影像清晰</p>
                </div>
            </div>
            <button id="take-photo-btn" style="display: none;">
                <div class="icon">📷</div>
                拍照識別食材
            </button>
            <canvas id="canvas" style="display: none;"></canvas> <div id="identified-ingredients" style="display: none;">
                <p>已識別食材：<span id="ingredients-display"></span></p>
                <button id="clear-identified-btn" style="background-color: #dc3545; margin-top: 10px; width: auto; padding: 10px 20px; font-size: 1.2em; max-width: none;">清空已識別食材</button>
            </div>

            <button id="confirm-ingredients-btn" style="display: none;">確認食材，尋找食譜</button>

            <div class="ingredient-input-group">
                <label for="manual-ingredient-input">手動輸入食材 (若掃描不便)</label>
                <input type="text" id="manual-ingredient-input" placeholder="例如：雞蛋、米飯">
                <button onclick="addManualIngredient()">加入食材</button>
            </div>

            <div class="ingredient-input-group">
                <label>或從常用食材中選擇：</label>
                <div class="ingredient-tags" id="common-ingredients-tags">
                    </div>
                <button id="find-recipes-manual-btn">查找食譜</button>
            </div>
        </section>

        <section id="recipe-list-page" class="section">
            <h2>推薦食譜</h2>
            <div class="recipe-list" id="recipes-container">
                </div>
        </section>

        <section id="recipe-detail-page" class="section">
            <h2 id="recipe-title-display"></h2>
            <div class="recipe-info">
                <p><strong>所需食材：</strong><span id="recipe-ingredients-display"></span></p>
                <p><strong>烹飪難度：</strong><span id="recipe-difficulty-display"></span></p>
                <p><strong>預計時間：</strong><span id="recipe-time-display"></span></p>
                <p><strong>健康提示：</strong><span id="recipe-health-display"></span></p>
                <p><strong>簡介：</strong><span id="recipe-intro-display"></span></p>
            </div>
            <hr>
            <h3>烹飪步驟</h3>
            <div id="recipe-steps-container">
                </div>

            <div class="navigation-buttons">
                <button class="nav-back" onclick="prevStep()">上一步</button>
                <button class="nav-next" onclick="nextStep()">下一步</button>
            </div>

            <div class="bottom-actions">
                <button class="favorite-btn" onclick="addToFavorites()">⭐ 加入最愛</button>
                <button class="shopping-btn" onclick="generateShoppingList()">🛒 產生購物清單</button>
            </div>
        </section>
    </main>

    <div id="recognition-modal">
        <div class="modal-content">
            <h3>OpenRouter 識別結果</h3>
            <p class="recognized-items">您掃描到了：<span id="modal-recognized-ingredients"></span></p>
            <div class="modal-buttons">
                <button class="modal-confirm-btn" onclick="confirmRecognition()">確認</button>
                <button class="modal-re-scan-btn" onclick="hideRecognitionModal()">重新掃描/修改</button>
            </div>
        </div>
    </div>

    <div id="loading-indicator">
        <div class="spinner"></div>
        <p>AI 正在努力識別中，請稍候...</p>
    </div>


    <script>
        // JavaScript 用於控制頁面顯示邏輯、數據處理和互動

        // 當前顯示的頁面
        let currentPage = 'scan-page';
        // 當前選中的食譜
        let currentRecipe = null;
        // 當前食譜的步驟
        let currentRecipeSteps = [];
        // 當前烹飪步驟索引
        let currentStepIndex = 0;
        // 語音導覽開關
        let voiceGuideEnabled = false;

        let videoStream = null; // 用於儲存攝像頭串流

        // OpenRouter API 配置
        const OPENROUTER_API_KEY = atob("c2stb3ItdjEtMzE2NjIwNGI1MjQ5MTg2MDFjMzMwNmY0YjFkMmVjYzAzZmZhMGMxNDQ4ODczNTZjODFjMmZiZjYzYzJlN2M4YQ=="); // **請替換為您的實際 API 金鑰！生產環境請勿直接暴露！**
        const OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        // 選擇一個支援多模態輸入的 Gemma 模型或其變體。
        // 請務必查閱 OpenRouter 文檔獲取最新和最合適的模型ID。
        // 例如：可能會有類似 'google/gemma-vision' 或 'google/gemma-large-vision' 的模型，
        // 或者需要搭配另一個視覺模型。這裡先用一個通用概念性的名稱。
        const OPENROUTER_MODEL = 'google/gemma-2-9b-it:free'; // 示例：這可能不是 OpenRouter 上準確的多模態 Gemma 模型 ID，請替換！

        // 模擬數據庫 (實際會從後端獲取) - 保持與上一個版本相同的大量食譜數據
        const mockRecipes = [
            {
                name: '滷水拼盤',
                keyIngredients: ['豬肉', '豬耳', '豬腸', '雞蛋', '豆乾', '滷水汁'],
                ingredients: ['豬肉', '豬耳', '豬腸', '雞蛋', '豆乾', '滷水汁'],
                difficulty: '中級', time: '120分鐘', health: '蛋白質豐富', intro: '多種食材滷製而成，風味濃郁，是下酒好菜。', image: 'https://via.placeholder.com/300x200?text=滷水拼盤',
                steps: [
                    { number: 1, text: '將豬肉、豬耳、豬腸洗淨焯水。雞蛋煮熟剝殼，豆乾切塊。', image: 'https://via.placeholder.com/400x300?text=準備滷水食材', timer: null },
                    { number: 2, text: '鍋中加入滷水汁，放入所有食材，大火煮開轉小火滷煮至少1小時，讓食材充分入味。', image: 'https://via.placeholder.com/400x300?text=滷煮', timer: '60分鐘' },
                    { number: 3, text: '關火後讓食材在滷汁中浸泡更長時間，上桌前切片擺盤即可。', image: 'https://via.placeholder.com/400x300?text=擺盤', timer: null }
                ]
            },
            {
                name: '涼拌茄子',
                keyIngredients: ['茄子', '蒜', '醬油', '醋'],
                ingredients: ['茄子', '蒜', '醬油', '醋', '麻油', '香菜'],
                difficulty: '初級', time: '20分鐘', health: '清爽、易消化', intro: '清涼開胃的夏季小菜，茄子軟糯，蒜香濃郁。', image: 'https://via.placeholder.com/300x200?text=涼拌茄子',
                steps: [
                    { number: 1, text: '茄子洗淨切成長條狀，蒸熟或煮熟。', image: 'https://via.placeholder.com/400x300?text=蒸茄子', timer: '10分鐘' },
                    { number: 2, text: '將蒜末、醬油、醋、麻油、少許糖和鹽混合成醬汁。', image: 'https://via.placeholder.com/400x300?text=調醬汁', timer: null },
                    { number: 3, text: '蒸好的茄子放涼後，淋上調好的醬汁，撒上香菜即可。', image: 'https://via.placeholder.com/400x300?text=涼拌', timer: null }
                ]
            },
            {
                name: '涼拌黃瓜',
                keyIngredients: ['黃瓜', '蒜', '醋'],
                ingredients: ['黃瓜', '蒜', '醋', '麻油', '辣椒'],
                difficulty: '初級', time: '15分鐘', health: '清脆、低卡', intro: '簡單開胃的家常小菜，黃瓜清爽，酸辣可口。', image: 'https://via.placeholder.com/300x200?text=涼拌黃瓜',
                steps: [
                    { number: 1, text: '黃瓜洗淨拍碎或切片，用少許鹽醃製10分鐘出水。', image: 'https://via.placeholder.com/400x300?text=拍黃瓜', timer: '10分鐘' },
                    { number: 2, text: '蒜末、醋、醬油、麻油和少許糖混合成醬汁。', image: 'https://via.placeholder.com/400x300?text=調醬', timer: null },
                    { number: 3, text: '將黃瓜瀝乾水分，淋上醬汁，拌勻即可。', image: 'https://via.placeholder.com/400x300?text=拌勻', timer: null }
                ]
            },
            {
                name: '蒜蓉炒菠菜',
                keyIngredients: ['菠菜', '蒜'],
                ingredients: ['菠菜', '蒜', '鹽'],
                difficulty: '初級', time: '10分鐘', health: '高纖維', intro: '簡單快速的家常素菜，菠菜清甜，蒜香濃郁。', image: 'https://via.placeholder.com/300x200?text=蒜蓉炒菠菜',
                steps: [
                    { number: 1, text: '菠菜洗淨瀝乾，切段。蒜切末。', image: 'https://via.placeholder.com/400x300?text=準備菠菜', timer: null },
                    { number: 2, text: '鍋中放油燒熱，放入蒜末爆香。', image: 'https://via.placeholder.com/400x300?text=爆香蒜', timer: null },
                    { number: 3, text: '倒入菠菜大火快速翻炒至軟身，加鹽調味即可。', image: 'https://via.placeholder.com/400x300?text=炒菠菜', timer: null }
                ]
            },
            {
                name: '清炒小白菜',
                keyIngredients: ['小白菜', '蒜'],
                ingredients: ['小白菜', '蒜', '鹽'],
                difficulty: '初級', time: '10分鐘', health: '高纖維', intro: '清淡爽口，保留小白菜的原味。', image: 'https://via.placeholder.com/300x200?text=清炒小白菜',
                steps: [
                    { number: 1, text: '小白菜洗淨切段，蒜切末。', image: 'https://via.placeholder.com/400x300?text=準備小白菜', timer: null },
                    { number: 2, text: '鍋中放油燒熱，放入蒜末爆香。', image: 'https://via.placeholder.com/400x300?text=爆香蒜', timer: null },
                    { number: 3, text: '倒入小白菜大火快速翻炒至軟身，加鹽調味即可。', image: 'https://via.placeholder.com/400x300?text=炒小白菜', timer: null }
                ]
            },
            {
                name: '醋溜土豆絲',
                keyIngredients: ['土豆', '醋', '蒜'],
                ingredients: ['土豆', '醋', '蒜', '辣椒', '花椒'],
                difficulty: '中級', time: '20分鐘', health: '開胃', intro: '酸辣爽脆，非常下飯的家常菜。', image: 'https://via.placeholder.com/300x200?text=醋溜土豆絲',
                steps: [
                    { number: 1, text: '土豆去皮切細絲，用清水沖洗數遍去除澱粉，瀝乾。', image: 'https://via.placeholder.com/400x300?text=切土豆絲', timer: null },
                    { number: 2, text: '鍋中放油燒熱，放入蒜末、乾辣椒、花椒爆香。', image: 'https://via.placeholder.com/400x300?text=爆香', timer: null },
                    { number: 3, text: '倒入土豆絲大火快速翻炒，加入醋、鹽、糖調味，炒至土豆絲熟透變脆即可。', image: 'https://via.placeholder.com/400x300?text=炒土豆絲', timer: null }
                ]
            },
            {
                name: '番茄炒蛋',
                keyIngredients: ['番茄', '雞蛋'],
                ingredients: ['番茄', '雞蛋', '蔥', '鹽', '糖'],
                difficulty: '初級', time: '15分鐘', health: '高纖易消化、素食', intro: '經典家常菜，番茄的酸甜與雞蛋的滑嫩完美結合。', image: 'https://via.placeholder.com/300x200?text=番茄炒蛋',
                steps: [
                    { number: 1, text: '番茄洗淨切塊，雞蛋打散加入少許鹽。', image: 'https://via.placeholder.com/400x300?text=準備番茄雞蛋', timer: null },
                    { number: 2, text: '鍋中放油燒熱，倒入蛋液快速炒熟，盛出備用。', image: 'https://via.placeholder.com/400x300?text=炒蛋', timer: null },
                    { number: 3, text: '鍋中再加少許油，放入番茄塊炒出汁，加入少許糖和鹽調味。', image: 'https://via.placeholder.com/400x300?text=炒番茄', timer: null },
                    { number: 4, text: '倒入炒好的雞蛋，快速翻炒均勻，撒上蔥花即可。', image: 'https://via.placeholder.com/400x300?text=番茄雞蛋合炒', timer: null }
                ]
            },
            {
                name: '蒜蓉炒空心菜',
                keyIngredients: ['空心菜', '蒜'],
                ingredients: ['空心菜', '蒜', '鹽'],
                difficulty: '初級', time: '10分鐘', health: '高纖維', intro: '夏季常見的快手菜，空心菜清脆爽口。', image: 'https://via.placeholder.com/300x200?text=蒜蓉炒空心菜',
                steps: [
                    { number: 1, text: '空心菜洗淨切段，蒜切末。', image: 'https://via.placeholder.com/400x300?text=準備空心菜', timer: null },
                    { number: 2, text: '鍋中放油燒熱，放入蒜末爆香。', image: 'https://via.placeholder.com/400x300?text=爆香蒜', timer: null },
                    { number: 3, text: '倒入空心菜大火快速翻炒至軟身，加鹽調味即可。', image: 'https://via.placeholder.com/400x300?text=炒空心菜', timer: null }
                ]
            },
            {
                name: '涼拌海帶絲',
                keyIngredients: ['海帶', '蒜', '醋'],
                ingredients: ['海帶', '蒜', '醋', '麻油', '辣椒'],
                difficulty: '初級', time: '20分鐘', health: '低卡、高碘', intro: '清爽開胃，營養豐富的海帶小菜。', image: 'https://via.placeholder.com/300x200?text=涼拌海帶絲',
                steps: [
                    { number: 1, text: '乾海帶提前泡發後洗淨切絲，煮熟後撈出放涼。', image: 'https://via.placeholder.com/400x300?text=處理海帶', timer: '10分鐘' },
                    { number: 2, text: '蒜末、醋、醬油、麻油、辣椒油混合成醬汁。', image: 'https://via.placeholder.com/400x300?text=調醬汁', timer: null },
                    { number: 3, text: '將海帶絲與醬汁拌勻即可。', image: 'https://via.placeholder.com/400x300?text=拌海帶絲', timer: null }
                ]
            },
            {
                name: '蚝油生菜',
                keyIngredients: ['生菜', '蚝油', '蒜'],
                ingredients: ['生菜', '蚝油', '蒜', '白糖'],
                difficulty: '初級', time: '10分鐘', health: '清淡、易消化', intro: '簡單快手，生菜清脆，蚝油提鮮。', image: 'https://via.placeholder.com/300x200?text=蚝油生菜',
                steps: [
                    { number: 1, text: '生菜洗淨瀝乾。蒜切末。', image: 'https://via.placeholder.com/400x300?text=準備生菜', timer: null },
                    { number: 2, text: '鍋中燒水，水開後放入生菜焯燙幾秒迅速撈出。', image: 'https://via.placeholder.com/400x300?text=焯生菜', timer: '1分鐘' },
                    { number: 3, text: '另起鍋，放油燒熱，爆香蒜末，加入蚝油、少許水和糖煮成醬汁。', image: 'https://via.placeholder.com/400x300?text=煮醬汁', timer: null },
                    { number: 4, text: '將焯好的生菜擺盤，淋上蚝油醬汁即可。', image: 'https://via.placeholder.com/400x300?text=淋醬', timer: null }
                ]
            },
            {
                name: '麻婆豆腐',
                keyIngredients: ['豆腐', '豬肉', '豆瓣醬', '花椒', '辣椒'],
                ingredients: ['豆腐', '豬肉', '豆瓣醬', '花椒', '辣椒', '蒜', '薑', '蔥'],
                difficulty: '中級', time: '25分鐘', health: '麻辣開胃', intro: '經典川菜，豆腐滑嫩，麻辣鮮香。', image: 'https://via.placeholder.com/300x200?text=麻婆豆腐',
                steps: [
                    { number: 1, text: '豆腐切小塊，用開水加少許鹽焯燙幾分鐘後撈出瀝乾。豬肉剁成肉末。', image: 'https://via.placeholder.com/400x300?text=準備豆腐肉末', timer: '5分鐘' },
                    { number: 2, text: '鍋中放油，炒香肉末，加入豆瓣醬炒出紅油，再加入蒜末、薑末、辣椒粉、花椒粉炒香。', image: 'https://via.placeholder.com/400x300?text=炒肉末醬料', timer: null },
                    { number: 3, text: '加入適量高湯或水，放入豆腐煮開，小火慢煮幾分鐘讓豆腐入味。', image: 'https://via.placeholder.com/400x300?text=煮豆腐', timer: '5分鐘' },
                    { number: 4, text: '勾芡，撒上蔥花即可。', image: 'https://via.placeholder.com/400x300?text=勾芡', timer: null }
                ]
            },
            {
                name: '豆豉鯪魚油麥菜',
                keyIngredients: ['油麥菜', '豆豉鯪魚罐頭'],
                ingredients: ['油麥菜', '豆豉鯪魚罐頭', '蒜'],
                difficulty: '初級', time: '15分鐘', health: '方便快捷', intro: '香港家常菜，豆豉鯪魚的鹹香與油麥菜的清甜結合。', image: 'https://via.placeholder.com/300x200?text=豆豉鯪魚油麥菜',
                steps: [
                    { number: 1, text: '油麥菜洗淨切段。打開豆豉鯪魚罐頭，魚肉輕輕分開。', image: 'https://via.placeholder.com/400x300?text=準備食材', timer: null },
                    { number: 2, text: '鍋中放少許罐頭裡的油燒熱，爆香蒜末。', image: 'https://via.placeholder.com/400x300?text=爆香', timer: null },
                    { number: 3, text: '倒入油麥菜大火快速翻炒，加入豆豉和部分鯪魚肉，炒至油麥菜變軟即可。', image: 'https://via.placeholder.com/400x300?text=快炒', timer: null }
                ]
            },
            {
                name: '蒜蓉蒸茄子',
                keyIngredients: ['茄子', '蒜', '醬油'],
                ingredients: ['茄子', '蒜', '醬油', '麻油', '蔥花'],
                difficulty: '初級', time: '20分鐘', health: '清蒸、健康', intro: '蒜香四溢，茄子軟糯，原汁原味。', image: 'https://via.placeholder.com/300x200?text=蒜蓉蒸茄子',
                steps: [
                    { number: 1, text: '茄子洗淨切成長條，鋪在盤中。蒜切末。', image: 'https://via.placeholder.com/400x300?text=準備茄子', timer: null },
                    { number: 2, text: '將茄子放入蒸鍋中，大火蒸約10-15分鐘至軟爛。', image: 'https://via.placeholder.com/400x300?text=蒸茄子', timer: '15分鐘' },
                    { number: 3, text: '蒸茄子時，將蒜末、醬油、麻油混合成醬汁。', image: 'https://via.placeholder.com/400x300?text=調醬汁', timer: null },
                    { number: 4, text: '蒸好的茄子取出，淋上醬汁，撒上蔥花即可。', image: 'https://via.placeholder.com/400x300?text=淋醬', timer: null }
                ]
            },
            {
                name: '涼拌豆芽',
                keyIngredients: ['豆芽', '蒜', '醋'],
                ingredients: ['豆芽', '蒜', '醋', '麻油', '辣椒'],
                difficulty: '初級', time: '15分鐘', health: '清脆、低卡', intro: '簡單清爽的開胃小菜。', image: 'https://via.placeholder.com/300x200?text=涼拌豆芽',
                steps: [
                    { number: 1, text: '豆芽洗淨，放入滾水中焯燙2-3分鐘後迅速撈出，用冷水沖涼瀝乾。', image: 'https://via.placeholder.com/400x300?text=焯豆芽', timer: '3分鐘' },
                    { number: 2, text: '蒜末、醋、醬油、麻油、少許糖和鹽混合成醬汁。', image: 'https://via.placeholder.com/400x300?text=調醬汁', timer: null },
                    { number: 3, text: '將豆芽與醬汁拌勻即可。', image: 'https://via.placeholder.com/400x300?text=拌豆芽', timer: null }
                ]
            },
            {
                name: '韭菜炒蛋',
                keyIngredients: ['韭菜', '雞蛋'],
                ingredients: ['韭菜', '雞蛋', '鹽'],
                difficulty: '初級', time: '15分鐘', health: '家常', intro: '簡單美味的家常菜，韭菜的香氣與雞蛋的鮮嫩結合。', image: 'https://via.placeholder.com/300x200?text=韭菜炒蛋',
                steps: [
                    { number: 1, text: '韭菜洗淨切段。雞蛋打散，加入少許鹽。', image: 'https://via.placeholder.com/400x300?text=準備韭菜雞蛋', timer: null },
                    { number: 2, text: '鍋中放油燒熱，倒入蛋液炒熟盛出。', image: 'https://via.placeholder.com/400x300?text=炒蛋', timer: null },
                    { number: 3, text: '鍋中再加少許油，放入韭菜段快速翻炒至斷生，倒入炒好的雞蛋，加鹽調味即可。', image: 'https://via.placeholder.com/400x300?text=炒韭菜蛋', timer: null }
                ]
            },
             {
                name: '苦瓜炒蛋',
                keyIngredients: ['苦瓜', '雞蛋'],
                ingredients: ['苦瓜', '雞蛋', '蒜', '鹽'],
                difficulty: '初級', time: '15分鐘', health: '清熱解毒', intro: '清熱解毒的家常菜，苦瓜的清苦與雞蛋的滑嫩形成對比。', image: 'https://via.placeholder.com/300x200?text=苦瓜炒蛋',
                steps: [
                    { number: 1, text: '苦瓜去籽切薄片，用鹽抓勻後靜置10分鐘出水，再沖洗乾淨減少苦味。雞蛋打散。', image: 'https://via.placeholder.com/400x300?text=處理苦瓜', timer: '10分鐘' },
                    { number: 2, text: '鍋中放油，先炒熟雞蛋盛出。', image: 'https://via.placeholder.com/400x300?text=炒蛋', timer: null },
                    { number: 3, text: '另起鍋，爆香蒜末，放入苦瓜片翻炒至斷生，加入炒好的雞蛋，加鹽調味即可。', image: 'https://via.placeholder.com/400x300?text=炒苦瓜蛋', timer: null }
                ]
            },
            {
                name: '苦瓜炒肉',
                keyIngredients: ['苦瓜', '豬肉'],
                ingredients: ['苦瓜', '豬肉', '蒜', '醬油'],
                difficulty: '中級', time: '20分鐘', health: '清熱解毒', intro: '苦瓜清脆，肉片鮮香，味道豐富。', image: 'https://via.placeholder.com/300x200?text=苦瓜炒肉',
                steps: [
                    { number: 1, text: '苦瓜去籽切薄片，用鹽抓勻後靜置10分鐘出水，再沖洗乾淨。豬肉切片。', image: 'https://via.placeholder.com/400x300?text=處理苦瓜肉', timer: '10分鐘' },
                    { number: 2, text: '鍋中放油，炒香肉片，加入蒜末、醬油炒香。', image: 'https://via.placeholder.com/400x300?text=炒肉', timer: null },
                    { number: 3, text: '倒入苦瓜片翻炒，與肉片混合均勻，加鹽調味，炒至苦瓜斷生即可。', image: 'https://via.placeholder.com/400x300?text=炒苦瓜肉', timer: null }
                ]
            },
            {
                name: '蔥油拌麵',
                keyIngredients: ['麵條', '蔥', '醬油'],
                ingredients: ['麵條', '蔥', '醬油', '糖', '食用油'],
                difficulty: '初級', time: '15分鐘', health: '簡單主食', intro: '家常簡餐，蔥油的香氣與麵條的Q彈完美結合。', image: 'https://via.placeholder.com/300x200?text=蔥油拌麵',
                steps: [
                    { number: 1, text: '細蔥切成蔥花。麵條煮熟後撈出，用少量香油拌勻防止粘連。', image: 'https://via.placeholder.com/400x300?text=準備麵條蔥花', timer: '8分鐘' },
                    { number: 2, text: '鍋中放入較多食用油，小火炸蔥花至金黃酥脆，撈出蔥渣。', image: 'https://via.placeholder.com/400x300?text=炸蔥油', timer: '5分鐘' },
                    { number: 3, text: '在碗中放入醬油、少許糖，倒入熱蔥油拌勻，再加入麵條和炸好的蔥花，拌勻即可。', image: 'https://via.placeholder.com/400x300?text=拌麵', timer: null }
                ]
            },
            {
                name: '香菇滑雞',
                keyIngredients: ['雞腿肉', '香菇', '薑', '蔥'],
                ingredients: ['雞腿肉', '香菇', '薑', '蔥', '蠔油', '生抽', '麻油', '澱粉'],
                difficulty: '中級', time: '30分鐘', health: '鮮美可口', intro: '雞肉滑嫩，香菇鮮香，家常下飯菜。', image: 'https://via.placeholder.com/300x200?text=香菇滑雞',
                steps: [
                    { number: 1, text: '雞腿肉切塊，用生抽、麻油、澱粉醃製15分鐘。香菇泡軟切片，薑切片，蔥切段。', image: 'https://via.placeholder.com/400x300?text=準備滑雞食材', timer: '15分鐘' },
                    { number: 2, text: '鍋中放油燒熱，爆香薑片和蔥段，放入雞肉炒至變色。', image: 'https://via.placeholder.com/400x300?text=炒雞肉', timer: null },
                    { number: 3, text: '加入香菇片翻炒，倒入蠔油和適量水，煮至雞肉熟透，勾芡即可。', image: 'https://via.placeholder.com/400x300?text=煮滑雞', timer: null }
                ]
            },
            {
                name: '青椒炒肉絲',
                keyIngredients: ['豬肉', '青椒'],
                ingredients: ['豬肉', '青椒', '醬油', '澱粉', '蒜'],
                difficulty: '中級', time: '20分鐘', health: '家常', intro: '簡單快速的家常小炒，青椒清脆，肉絲入味。', image: 'https://via.placeholder.com/300x200?text=青椒炒肉絲',
                steps: [
                    { number: 1, text: '豬肉切絲，用醬油、澱粉醃製。青椒切絲，蒜切末。', image: 'https://via.placeholder.com/400x300?text=準備肉絲青椒', timer: null },
                    { number: 2, text: '鍋中放油燒熱，放入肉絲炒至變色盛出。', image: 'https://via.placeholder.com/400x300?text=炒肉絲', timer: null },
                    { number: 3, text: '另起鍋，爆香蒜末，放入青椒絲翻炒至斷生，倒入肉絲，加鹽調味，快速翻炒均勻即可。', image: 'https://via.placeholder.com/400x300?text=炒青椒肉絲', timer: null }
                ]
            },
             {
                name: '清蒸鱸魚',
                keyIngredients: ['鱸魚', '薑', '蔥'],
                ingredients: ['鱸魚', '薑', '蔥', '蒸魚豉油', '食用油'],
                difficulty: '中級', time: '25分鐘', health: '高蛋白、低脂', intro: '經典粵菜做法，最大程度保留魚肉的鮮甜和營養。', image: 'https://via.placeholder.com/300x200?text=清蒸鱸魚',
                steps: [
                    { number: 1, text: '鱸魚處理乾淨，兩面斜刀劃幾刀，用鹽和料酒醃製10分鐘。薑切片、蔥切段和薑絲。', image: 'https://via.placeholder.com/400x300?text=準備鱸魚', timer: '10分鐘' },
                    { number: 2, text: '盤底鋪上薑片和蔥段，放上鱸魚，魚身也放些薑片和蔥段。水開後放入蒸鍋，大火蒸8-10分鐘。', image: 'https://via.placeholder.com/400x300?text=蒸魚', timer: '10分鐘' },
                    { number: 3, text: '取出蒸好的魚，倒掉盤中水分，淋上蒸魚豉油，鋪上新鮮薑絲和蔥絲。', image: 'https://via.placeholder.com/400x300?text=淋蒸魚豉油', timer: null },
                    { number: 4, text: '另起鍋燒熱適量食用油，淋在薑絲和蔥絲上，激發香味即可。', image: 'https://via.placeholder.com/400x300?text=淋熱油', timer: null }
                ]
            }
            // ... 可以繼續添加更多食譜數據
        ];

        // 常用食材的列表，用於生成標籤
        const commonIngredients = Array.from(new Set(mockRecipes.flatMap(recipe => recipe.ingredients)));
        let identifiedIngredients = new Set(); // 用於儲存已識別的食材，使用 Set 避免重複

        // 頁面元素獲取
        const scanPage = document.getElementById('scan-page');
        const recipeListPage = document.getElementById('recipe-list-page');
        const recipeDetailPage = document.getElementById('recipe-detail-page');
        const topNavbar = document.getElementById('top-navbar');
        const navTitle = document.getElementById('nav-title');

        const startCameraButton = document.getElementById('start-camera-btn');
        const takePhotoButton = document.getElementById('take-photo-btn');
        const cameraStream = document.getElementById('camera-stream');
        const scanOverlayText = document.getElementById('scan-overlay-text');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const identifiedIngredientsDiv = document.getElementById('identified-ingredients');
        const ingredientsDisplay = document.getElementById('ingredients-display');
        const clearIdentifiedButton = document.getElementById('clear-identified-btn');
        const confirmIngredientsButton = document.getElementById('confirm-ingredients-btn');

        const manualIngredientInput = document.getElementById('manual-ingredient-input');
        const commonIngredientsTagsContainer = document.getElementById('common-ingredients-tags');
        const findRecipesManualButton = document.getElementById('find-recipes-manual-btn');

        const recipesContainer = document.getElementById('recipes-container');

        const recipeTitleDisplay = document.getElementById('recipe-title-display');
        const recipeIngredientsDisplay = document.getElementById('recipe-ingredients-display');
        const recipeDifficultyDisplay = document.getElementById('recipe-difficulty-display');
        const recipeTimeDisplay = document.getElementById('recipe-time-display');
        const recipeHealthDisplay = document.getElementById('recipe-health-display');
        const recipeIntroDisplay = document.getElementById('recipe-intro-display');
        const recipeStepsContainer = document.getElementById('recipe-steps-container');

        const recognitionModal = document.getElementById('recognition-modal');
        const modalRecognizedIngredients = document.getElementById('modal-recognized-ingredients');
        const loadingIndicator = document.getElementById('loading-indicator');

        // 初始化：根據 commonIngredients 生成標籤
        function initializeCommonIngredientsTags() {
            commonIngredientsTagsContainer.innerHTML = ''; // 清空現有標籤
            commonIngredients.forEach(ingredient => {
                const tag = document.createElement('span');
                tag.classList.add('ingredient-tag');
                tag.textContent = ingredient;
                tag.onclick = () => addIngredient(ingredient);
                commonIngredientsTagsContainer.appendChild(tag);
            });
        }

        // 載入時初始化常用食材標籤
        document.addEventListener('DOMContentLoaded', initializeCommonIngredientsTags);


        // 頁面導航功能
        function showPage(pageId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
            currentPage = pageId;

            // 根據頁面顯示/隱藏導航欄
            if (pageId === 'scan-page') {
                topNavbar.style.display = 'none';
            } else {
                topNavbar.style.display = 'flex';
                // 更新導航欄標題
                if (pageId === 'recipe-list-page') {
                    navTitle.textContent = '推薦食譜';
                } else if (pageId === 'recipe-detail-page' && currentRecipe) {
                    navTitle.textContent = currentRecipe.name;
                }
            }
        }

        // 返回上一頁
        function goBack() {
            if (currentPage === 'recipe-list-page') {
                showPage('scan-page');
                // 停止攝像頭串流 (如果正在運行)
                stopCamera();
            } else if (currentPage === 'recipe-detail-page') {
                showPage('recipe-list-page');
            }
        }

        // 攝像頭控制
        startCameraButton.addEventListener('click', startCamera);
        takePhotoButton.addEventListener('click', takePhoto);
        clearIdentifiedButton.addEventListener('click', clearIdentifiedIngredients);
        confirmIngredientsButton.addEventListener('click', findRecipesFromIdentified);
        findRecipesManualButton.addEventListener('click', findRecipesFromManualInput);

        async function startCamera() {
            try {
                // 檢查是否有攝像頭權限
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); // 優先使用後置攝像頭
                cameraStream.srcObject = stream;
                videoStream = stream; // 保存串流以便停止
                cameraStream.style.display = 'block';
                scanOverlayText.style.display = 'none';
                takePhotoButton.style.display = 'block';
                startCameraButton.style.display = 'none';
            } catch (err) {
                console.error("無法開啟攝像頭：", err);
                alert("無法開啟攝像頭，請檢查您的設備或瀏覽器權限設置。");
                scanOverlayText.innerHTML = '<span class="icon">❌</span><p>無法開啟攝像頭。</p><p>請確認已授予權限。</p>';
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                cameraStream.srcObject = null;
                cameraStream.style.display = 'none';
                scanOverlayText.style.display = 'block';
                takePhotoButton.style.display = 'none';
                startCameraButton.style.display = 'block';
            }
        }

        async function takePhoto() {
            if (!videoStream) {
                alert("請先開啟攝像頭！");
                return;
            }

            // 確保 canvas 尺寸與 video 匹配
            canvas.width = cameraStream.videoWidth;
            canvas.height = cameraStream.videoHeight;
            ctx.drawImage(cameraStream, 0, 0, canvas.width, canvas.height);

            // 將 canvas 內容轉換為 Base64 數據 URL
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8); // 0.8 是圖像品質

            showLoading(); // 顯示加載指示器
            await analyzeImageWithOpenRouter(imageDataUrl); // 調用 OpenRouter API 進行分析
        }

        async function analyzeImageWithOpenRouter(imageDataUrl) {
            try {
                // 提取 Base64 數據，移除前綴 "data:image/jpeg;base64,"
                const base64Image = imageDataUrl.split(',')[1];

                const response = await fetch(OPENROUTER_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: OPENROUTER_MODEL,
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: '請列出這張圖片中出現的食物或食材，並以逗號分隔，例如：蘋果, 香蕉, 牛奶。如果沒有識別到任何食物，請回答「無」。'
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: `data:image/jpeg;base64,${base64Image}`
                                        }
                                    }
                                ]
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('OpenRouter API 錯誤:', errorData);
                    throw new Error(`OpenRouter API 呼叫失敗: ${response.status} ${response.statusText} - ${errorData.message || ''}`);
                }

                const data = await response.json();
                console.log('OpenRouter API 回應:', data);

                let recognizedText = '無'; // 預設值
                if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
                    recognizedText = data.choices[0].message.content.trim();
                }

                // 彈出模態框顯示識別結果
                showRecognitionModal(recognizedText);

            } catch (error) {
                console.error('識別圖片時發生錯誤:', error);
                alert('識別食材時發生錯誤，請稍後再試。\n' + error.message);
                hideLoading(); // 隱藏加載指示器
            } finally {
                // 不在這裡隱藏 loading，在 confirmRecognition 或 hideRecognitionModal 裡隱藏
            }
        }

        function showLoading() {
            loadingIndicator.style.display = 'flex';
        }

        function hideLoading() {
            loadingIndicator.style.display = 'none';
        }

        function showRecognitionModal(recognizedItems) {
            modalRecognizedIngredients.textContent = recognizedItems;
            recognitionModal.style.display = 'flex'; // 顯示模態框
        }

        function hideRecognitionModal() {
            recognitionModal.style.display = 'none'; // 隱藏模態框
            hideLoading(); // 在關閉模態框時隱藏加載
        }

        function confirmRecognition() {
            const recognizedItemsText = modalRecognizedIngredients.textContent;
            hideRecognitionModal(); // 確認後隱藏模態框

            if (recognizedItemsText && recognizedItemsText !== '無') {
                recognizedItemsText.split(',').forEach(item => {
                    const trimmedItem = item.trim();
                    if (trimmedItem) {
                        addIngredient(trimmedItem);
                    }
                });
            } else {
                 alert('沒有識別到食材，請嘗試重新掃描或手動輸入。');
            }
        }

        // 添加食材到列表
        function addIngredient(ingredientName) {
            const normalizedIngredient = ingredientName.toLowerCase(); // 統一小寫

            if (!identifiedIngredients.has(normalizedIngredient)) {
                identifiedIngredients.add(normalizedIngredient);
                updateIdentifiedIngredientsDisplay();
                // 顯示確認按鈕和清空按鈕
                identifiedIngredientsDiv.style.display = 'block';
                confirmIngredientsButton.style.display = 'block';
            }
            manualIngredientInput.value = ''; // 清空手動輸入框
        }

        // 更新顯示已識別食材
        function updateIdentifiedIngredientsDisplay() {
            if (identifiedIngredients.size === 0) {
                ingredientsDisplay.textContent = '無';
                identifiedIngredientsDiv.style.display = 'none';
                confirmIngredientsButton.style.display = 'none';
            } else {
                ingredientsDisplay.textContent = Array.from(identifiedIngredients).map(item => {
                    // 將首字母大寫以提高可讀性
                    return item.charAt(0).toUpperCase() + item.slice(1);
                }).join('、');
                identifiedIngredientsDiv.style.display = 'block';
                confirmIngredientsButton.style.display = 'block';
            }
        }

        // 清空已識別食材
        function clearIdentifiedIngredients() {
            identifiedIngredients.clear();
            updateIdentifiedIngredientsDisplay();
        }

        // 手動添加食材
        function addManualIngredient() {
            const input = manualIngredientInput.value.trim();
            if (input) {
                input.split(/[,、\s]+/).forEach(item => { // 支持逗號、頓號或空格分隔
                    if (item) addIngredient(item);
                });
            } else {
                alert('請輸入食材名稱！');
            }
        }

        // 根據已識別的食材查找食譜
        function findRecipesFromIdentified() {
            if (identifiedIngredients.size === 0) {
                alert('請先掃描或手動輸入食材！');
                return;
            }
            const ingredientsArray = Array.from(identifiedIngredients);
            filterAndDisplayRecipes(ingredientsArray);
        }

        // 根據手動輸入的食材查找食譜
        function findRecipesFromManualInput() {
            const input = manualIngredientInput.value.trim();
            const selectedTags = Array.from(commonIngredientsTagsContainer.children)
                                    .filter(tag => tag.classList.contains('selected')) // 如果有選中狀態，這裡可以擴展
                                    .map(tag => tag.textContent);

            let ingredientsToSearch = [];
            if (input) {
                ingredientsToSearch = ingredientsToSearch.concat(input.split(/[,、\s]+/).filter(item => item !== ''));
            }
            ingredientsToSearch = ingredientsToSearch.concat(selectedTags);

            if (ingredientsToSearch.length === 0) {
                alert('請輸入或選擇食材！');
                return;
            }

            filterAndDisplayRecipes(ingredientsToSearch);
        }


        // 過濾並顯示食譜
        function filterAndDisplayRecipes(inputIngredients) {
            const normalizedInput = inputIngredients.map(item => item.toLowerCase());
            const foundRecipes = mockRecipes.filter(recipe => {
                // 檢查食譜的關鍵食材是否都在輸入食材中
                return recipe.keyIngredients.every(keyIng => normalizedInput.includes(keyIng.toLowerCase()));
            });

            recipesContainer.innerHTML = ''; // 清空現有食譜

            if (foundRecipes.length > 0) {
                foundRecipes.forEach(recipe => {
                    const card = document.createElement('div');
                    card.classList.add('recipe-card');
                    card.innerHTML = `
                        <img src="${recipe.image}" alt="${recipe.name}">
                        <div class="recipe-card-content">
                            <h3>${recipe.name}</h3>
                            <p><strong>難度:</strong> ${recipe.difficulty}</p>
                            <p><strong>時間:</strong> ${recipe.time}</p>
                            <p><strong>簡介:</strong> ${recipe.intro.substring(0, 50)}...</p>
                            <div class="tags">
                                ${recipe.keyIngredients.map(ing => `<span>${ing}</span>`).join('')}
                            </div>
                        </div>
                    `;
                    card.onclick = () => showRecipeDetail(recipe);
                    recipesContainer.appendChild(card);
                });
                showPage('recipe-list-page');
                stopCamera(); // 轉到食譜列表頁時停止攝像頭
            } else {
                alert('很抱歉，沒有找到符合您食材的食譜。請嘗試調整食材列表。');
            }
        }

        // 顯示食譜詳情
        function showRecipeDetail(recipe) {
            currentRecipe = recipe;
            currentRecipeSteps = recipe.steps;
            currentStepIndex = 0; // 重置步驟索引
            navTitle.textContent = recipe.name; // 更新頂部導航欄標題

            recipeTitleDisplay.textContent = recipe.name;
            recipeIngredientsDisplay.textContent = recipe.ingredients.join('、');
            recipeDifficultyDisplay.textContent = recipe.difficulty;
            recipeTimeDisplay.textContent = recipe.time;
            recipeHealthDisplay.textContent = recipe.health;
            recipeIntroDisplay.textContent = recipe.intro;

            displayCurrentStep(); // 顯示第一個步驟
            showPage('recipe-detail-page');
        }

        // 顯示當前步驟
        function displayCurrentStep() {
            recipeStepsContainer.innerHTML = '';
            if (currentRecipeSteps.length === 0) {
                recipeStepsContainer.innerHTML = '<p style="text-align: center; font-size: 1.5em; color: #dc3545;">沒有烹飪步驟信息。</p>';
                return;
            }

            const step = currentRecipeSteps[currentStepIndex];
            const stepDiv = document.createElement('div');
            stepDiv.classList.add('recipe-step');
            stepDiv.innerHTML = `
                <div class="step-number">步驟 ${step.number} / ${currentRecipeSteps.length}</div>
                ${step.image ? `<div class="step-image"><img src="${step.image}" alt="步驟 ${step.number} 圖片"></div>` : ''}
                <div class="step-text">${step.text}</div>
                ${step.timer ? `<div class="step-timer">計時器：${step.timer}</div>` : ''}
            `;
            recipeStepsContainer.appendChild(stepDiv);

            // 更新導航按鈕狀態
            document.querySelector('.nav-back').disabled = (currentStepIndex === 0);
            document.querySelector('.nav-next').disabled = (currentStepIndex === currentRecipeSteps.length - 1);

            // 如果語音導覽啟用，則朗讀當前步驟
            if (voiceGuideEnabled) {
                speakText(`步驟 ${step.number}：${step.text}`);
                if (step.timer) {
                    speakText(`計時器：${step.timer}`);
                }
            }
        }

        // 上一步
        function prevStep() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                displayCurrentStep();
            }
        }

        // 下一步
        function nextStep() {
            if (currentStepIndex < currentRecipeSteps.length - 1) {
                currentStepIndex++;
                displayCurrentStep();
            }
        }

        // 語音導覽開關
        function toggleVoiceGuide() {
            voiceGuideEnabled = !voiceGuideEnabled;
            alert(`語音導覽已${voiceGuideEnabled ? '開啟' : '關閉'}`);
            // 可以改變按鈕圖示或顏色來表示狀態
        }

        // 文本轉語音功能
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW'; // 設定語音語言為繁體中文
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn('您的瀏覽器不支持 Web Speech API。');
            }
        }

        // 收藏功能 (佔位符)
        function addToFavorites() {
            if (currentRecipe) {
                alert(`已將「${currentRecipe.name}」加入您的最愛！(此為模擬功能)`);
                // 實際應用中會將食譜數據保存到本地儲存或後端
            }
        }

        // 生成購物清單功能 (佔位符)
        function generateShoppingList() {
            if (currentRecipe) {
                const ingredients = currentRecipe.ingredients.join('、');
                alert(`為「${currentRecipe.name}」生成購物清單：\n${ingredients}\n(此為模擬功能)`);
                // 實際應用中會將食材整理成更友好的購物清單格式
            }
        }

    </script>
</body>
</html>
